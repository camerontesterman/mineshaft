#!/usr/bin/ruby
#
# mineshaft
#
# author:: Cameron Testerman
# email:: cameronbtesterman@gmail.com
# created:: 2017-04-14 1:19PM
#
# Copyright (c) 2017-2018 Cameron Testerman

require "mineshaft"
require "optparse"
require "yaml"
extend Mineshaft::Sugar

options = {
  openssl_dir: "/usr/local/opt/openssl",
  version: Mineshaft::Constants::RUBY_VERSION_STABLE,
  global: false
}

if ARGV[0] == "new"
  env_name = ARGV[1]
  ruby_version = ARGV[2] if ARGV[2]
  mode = "new"
elsif ARGV[0] == "list"
  Mineshaft::List.display
elsif ARGV[0] == "reload"
  mode = ""
elsif ARGV[0] == "use"
  env_name = ARGV[ARGV.index("use") + 1]
  use_environment = true
end

parser = OptionParser.new do |opts|
  opts.banner = "Usage: ms [command] [options]"
  opts.separator ""
  opts.separator "Commands"
  opts.separator "    new                              creates new environment"
  opts.separator "    install                          installs a new global Ruby"
  opts.separator "    list                             lists the ten latest versions of Ruby available to install"
  opts.separator "    reload                           reloads binaries using the current global Ruby version"
  opts.separator "    use                              selects an installed global Ruby environment to use"
  opts.separator "    env                              shows a list of all installed global Rubies, with the current one in use highlighted"
  opts.separator ""
  opts.separator "Options"

  opts.on("-v",
    "--version",
    "displays the current version of mineshaft") do
      puts "Mineshaft v#{Mineshaft::VERSION}"
      exit
  end

  opts.on("-o",
    "--with-openssl-dir DIR",
    "specify the directory where OpenSSL is installed") do |openssl_dir|
      options[:openssl_dir] = openssl_dir
  end

  # opts.on("-g",
  #   "--global",
  #   "install the Ruby environment globally") do |global|
  #   options[:global] = true
  #   options[:version] = new_arg
  # end

  opts.on("-n",
    "--no-openssl-dir",
    "do not set the OpenSSL directory - otherwise this defaults to /usr/local/opt/openssl") do |no_openssl|
      options[:no_openssl_dir] = true
  end

  # opts.on("-i",
  #   "--installed",
  #   "lists the globally installed and available Rubies") do |installed|
  #   options[:installed] = true
  # end
end

parser.parse!

case ARGV[0]
when "new"
  env_name = ARGV[1]
  options[:version] = ARGV[2] if ARGV[2]

  Mineshaft::Environment.new(new_arg, options).create
when "list"
when "use"
when "reload"

else
  puts "Unrecognized command - #{ARGV[0]}" 
end

Mineshaft.reload_binaries if reload
Mineshaft.list_globals    if options[:installed]

if use_environment
  options[:global] = true
  Mineshaft::Environment.new(environment, options).use 
end


